%----------------------------------------------------------------------------
\chapter{Digitális tervezés}
%----------------------------------------------------------------------------
Az FPGA-ra a Xilinx ISE 14.3-as verzójú fejlesztõi környezetének segítségével fejlesztettem a rendszert. Ez nem egy kimondottan korszerû ám szerencsére hibamentes szoftver. Azért ezt választottam mégis, mert a Spartan 6-os FPGA-kat a szoftver korszerû alternatívája (a Vivado) már nem támogatja. A leírófájlokat, modulokat és testbench-eket Verilog nyelven készítettem el, viszont helyenként szükséges volt VHDL-ben implementált részekkel is foglalkoznom késõbb a hibakeresés során.

%----------------------------------------------------------------------------
\section{Modulok}
%----------------------------------------------------------------------------
A 1581-es meghajtót egy MOS 6502 típusú processzoron futó operációs rendszer irányítja. Az alaplapon megtalálható a firmware bináris állományát tartalmazó 32kB ROM és 8kB RAM. A perifériák kiszolgálását egy 8520-as komplex interfész adapter (CIA), a lemez író-olvasó egység vezérlését egy WD1772 típusú floppy meghajtó vezérlõ (FDC) integrált áramkör végzi. Ezek képezik a fõbb logikai egységeket, így kézenfekvõ volt modulba szervezni õket, és így beilleszteni a projektbe.

\begin{figure}[!ht]
\centering
\vspace{0.5cm}
\includegraphics[width=100mm, keepaspectratio]{figures/system.png}
\caption{Az FPGA-n megvalósított rendszer sematikus rajza}
\label{fig:HVSpaces}
\end{figure}

A rendszer 8-bites adatbuszt és 16 bites címbuszt használ, 2MHz-es rendszerórajelrõl jár minden a floppy vezérlõ kivételével, mely 8MHz-es órajelet igényel. Ezen órajelek elõállítása egy 4-bites számlálóval történt eredetileg, egy 16MHz-es oszcillátor jelének leosztásával. Érdekesség, hogy az ehhez alkalmazott 74LS93-as IC konfigurálható bitszámú: 3 vagy 4 bites számlálót is lehetséges kialakítani a segítségével. Egy ebben a témában végzett korábbi próbálkozás során a nem megfelelõ konfiguráció jelenthetett hibalehetõséget.

Az eredeti kapcsolásban az egyes logikai egységekhez tartozó címdekódolást és engedélyezõ jelek elõállítását multiplexerek végzik, a címtartomány az alábbiak szerint alakul:

\begin{table}[ht]
	\footnotesize
	\centering
	\caption{Az 1581-es meghajtó processzoros rendszerének címtartomány-kiosztása}
	\begin{tabular}{ | l | l |}
	\hline
	Eszköz & Címtartomány \\ \hline
	RAM & 0x0000-0x1FFF \\
	CIA & 0x4000-0x4010 \\
	FDC & 0x6000-0x6003 \\
	ROM & 0x8000-0xFFFF \\
	\hline
	\end{tabular}
	\label{tab:addressmap}
\end{table}

%TODO huzalozott logika megcsinálása
%TODO többféle mód a soros port használatára
%TODO kétirányú adatvonalak szétbontása két egyirányúra 

\subsection{CPU}
A 6502-es CPU 8-bites\cite{6502}\cite{instruction_set}\cite{programming_manual}

\subsection{FDC}
\cite{FDC}

\subsection{CIA}
A 8520-as komplex interfész adapter IC tartalmaz két 8-bites portot, két 16-bites idõzítõt, és egy valós idejû órát és egy dedikált soros port perifériát.\cite{cia}

különbözõ intellectual property-ket vadásztam össze innen-onnan (=korábbi munkák eredményét felhasználva)
kiegészítõ logikák
milyen verilog modulok vannak, miket csináltam én

melyik alegység mit csinál, hogy mûködik, mi van bennne
CIA: io bõvítõ + soros port + 2 timer
FDC: floppy vezérlõ xd
CPU: 6502 (belsõ felépítése, stb -> assembly oldalról fontos inkább, lásd brk flag)
%----------------------------------------------------------------------------
\section{Tesztelés}
%----------------------------------------------------------------------------
